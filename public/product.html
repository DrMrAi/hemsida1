<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PokÃ©market - Product</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>

<!-- HERO -->
<section class="hero">
    <div class="hero-overlay"></div>

    <header class="top-header">
        <div class="header-inner">
            <div class="logo">
                <h1>PokÃ©market</h1>
                <p>Collect. Buy. Live.</p>
            </div>

            <button class="login-btn">Log in</button>
        </div>
        <div class="basket-inner">
            <div></div> <!--ta bort plsss lÃ¶s pÃ¥ ett bÃ¤ttre sÃ¤tt-->
            <button class="basket-btn">Basket</button>
            <div class="basket-banner">
                <h3>Your Basket</h3>
                <ul id="shopping_basket"> </ul>

                <button class="close-btn">Close</button>
            </div>
        </div>
    </header>

    <nav class="category-nav">
        <button class="active">Product</button>
    </nav>
</section>

<!-- MAIN -->
<main class="container">

    <section class="product-page">
        <div class="product-image">
            <img id="product-img" src="" alt="">
        </div>

        <div class="product-info">
            <h2 id="product-name"></h2>

            <p class="product-desc" id="product-desc"></p>

            <p class="price" id="product-price"></p>

            <div class="quantity">
                <label for="qty">Quantity:</label>
                <input type="number" id="qty" value="1" min="1">
            </div>

            <button class="add-cart-btn" onclick="addToCart()">Add to Basket</button>
        </div>
    </section>

    <!-- CART -->
    <section class="cart">
        <h3>ðŸ›’ Basket</h3>
        <ul id="cart-items"></ul>
        <p id="total-price">Total: 0 kr</p>
    </section>

</main>

<script>
// --- Cart functionality ---
let cart = [];

function addToCart() {
    const name = document.getElementById("product-name").textContent;
    const price = parseFloat(document.getElementById("product-price").textContent);
    const qty = parseInt(document.getElementById("qty").value);
    const user_id = user.user_id ?? null; //Get ID from session and if not logged in, set to null
    const product_id = window.location.pathname.split("/").pop();
    cart.push({ name, price, qty });
    
    fetch('/api/order_line', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: user_id, product: product_id, amount: qty, price: price})
                })
    //renderCart();
    }



// --- Fetch product data dynamically ---
document.addEventListener('DOMContentLoaded', () => {
    const productId = window.location.pathname.split("/").pop();
    const loginBtn = document.querySelector('.login-btn');
    fetch('/api/me')
        .then(res => res.json())
        .then(data => {
            console.log('Login state:', data);

            if (data.logged_in) {
                loginBtn.textContent = 'Min profil';
                loginBtn.onclick = () => {
                    window.location.href = `/profile`;
                };
            } else {
                loginBtn.textContent = 'Logga in';
                loginBtn.onclick = () => {
                    window.location.href = `/login`;
                };
            }
        })
        .catch(err => {
            console.error('ME error:', err);
            loginBtn.textContent = 'Logga in';
        });
    fetch(`/api/products/${productId}`)
        .then(res => {
            if (!res.ok) throw new Error("Product not found");
            return res.json();
        })
        .then(product => {
            // Replace "200w" with "400w" in image URL
            const highResImageUrl = product.image_url ? product.image_url.replace('200w', '400w') : '';

            document.getElementById("product-img").src = highResImageUrl;
            document.getElementById("product-img").alt = product.name;
            document.getElementById("product-name").textContent = product.name + " - Diamond & Pearl";
            document.getElementById("product-desc").textContent = product.description || "No description available.";
            document.getElementById("product-price").textContent = parseFloat(product.price || 0).toFixed(2);
        })
        .catch(err => {
            console.error(err);
            document.querySelector(".product-page").innerHTML = "<p>Product not found.</p>";
        });
});
    document.querySelector('.login-btn').addEventListener('click', ()=> {
        window.location.href = '/login';
    });

document.querySelector('.basket-btn').addEventListener('click', () => {
    const banner = document.querySelector('.basket-banner');
    banner.classList.add('active');
    renderCart();
});

function renderCart() {
const params = new URLSearchParams(window.location.search);
const user_id = params.get('id');
fetch(`/api/current_order/${user_id}`)
    .then(res => {
        if (!res.ok) throw new Error("Product not found");
        return res.json();
    })
    .then(products => {
        console.log("Yippie", products);
        const list = document.getElementById("shopping_basket");;
        list.innerHTML = "";
        let total = 0;

        products.forEach(item => {
            console.log("item", item)
            const li = document.createElement("li");
            li.textContent = `${item.name} x${item.amount} - ${(item.price * item.amount).toFixed(2)} kr`;
            list.appendChild(li);
            total += item.price * item.qty;
        });
    })
    .catch(err => {
        console.error(err);
        //LÃ„GG TILL ERROR KANSKE??
    });
}

document.querySelector('.close-btn').addEventListener('click', (e) => {
    if (e.target.classList.contains('close-btn')) {
        const banner = document.querySelector('.basket-banner');
        banner.classList.remove('active');
    }
});

</script>

</body>
</html>
