<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PokÃ©market - Product</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>

<!-- HERO -->
<section class="hero">
    <div class="hero-overlay"></div>

    <header class="top-header">
        <div class="header-inner">
            <div class="logo">
                <a href="/" class="logo-link">
                    <h1>PokÃ©market</h1>
                    <p>Samla. KÃ¶p. Lev. hej hej</p>
                </a>
            </div>

            <button class="login-btn">Log in</button>
        </div>
        <div class="basket-inner">
            <div></div> <!--ta bort plsss lÃ¶s pÃ¥ ett bÃ¤ttre sÃ¤tt-->
            <button class="basket-btn">Basket</button>
            <div class="basket-banner">
                <button class="close-btn">Close</button>
                <h3>Your Basket</h3> 
                <div id="shopping_basket"> </div>
                <button class="buy-btn" style="display:none" onclick="buyOrder()">Buy</button>
            </div>
        </div>
    </header>

    <nav class="category-nav">
        <button class="active">Product</button>
    </nav>
</section>

<!-- MAIN -->
<main class="container">

    <section class="product-page">
        <div class="product-image">
            <img id="product-img" src="" alt="">
        </div>

        <div class="product-info">
            <h2 id="product-name"></h2>

            <p class="product-desc" id="product-desc"></p>

            <p class="price" id="product-price"></p>

            <div class="quantity">
                <label for="qty">Quantity:</label>
                <input type="number" id="qty" value="1" min="1">
            </div>

            <button class="add-cart-btn" onclick="addToCart()">Add to Basket</button>
        </div>
    </section>

    <!-- CART 
    <section class="cart">
        <h3>ðŸ›’ Basket</h3>
        <ul id="cart-items"></ul>
        <p id="total-price">Total: 0 kr</p>
    </section>
-->
</main>

<script>
// --- Cart functionality ---
let cart = [];

async function addToCart() {
    const name = document.getElementById("product-name").textContent;
    const price = parseFloat(document.getElementById("product-price").textContent);
    const qty = (parseInt(document.getElementById("qty").value) < 1) ? 1 : parseInt(document.getElementById("qty").value); 
    const user = await getUser();
    const user_id = user ? user.id : null;
    console.log("Received user_id from getUser():", user_id);
    console.log("user_id in addToCart:", user_id);
    console.log("Received ID from /api/me:", user_id);
        
    console.log("Adding to cart:", { name, price, qty, user_id });
    const product_id = window.location.pathname.split("/").pop();
    cart.push({ name, price, qty });
    
    fetch('/api/order_line', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user: user_id, product: product_id, amount: qty, price: price})
    });
    renderCart();
    }



// --- Fetch product data dynamically ---
document.addEventListener('DOMContentLoaded', () => {
    const productId = window.location.pathname.split("/").pop();
    const loginBtn = document.querySelector('.login-btn');
    fetch('/api/me')
        .then(res => res.json())
        .then(data => {
            console.log('Login state:', data);

            if (data.logged_in) {
                loginBtn.textContent = 'Min profil';
                loginBtn.onclick = () => {
                    window.location.href = `/profile`;
                };
            } else {
                loginBtn.textContent = 'Logga in';
                loginBtn.onclick = () => {
                    window.location.href = `/login`;
                };
            }
        })
        .catch(err => {
            console.error('ME error:', err);
            loginBtn.textContent = 'Logga in';
        });
    fetch(`/api/products/${productId}`)
        .then(res => {
            if (!res.ok) throw new Error("Product not found");
            return res.json();
        })
        .then(product => {
            // Replace "200w" with "400w" in image URL
            const highResImageUrl = product.image_url ? product.image_url.replace('200w', '400w') : '';

            document.getElementById("product-img").src = highResImageUrl;
            document.getElementById("product-img").alt = product.name;
            document.getElementById("product-name").textContent = product.name + " - Diamond & Pearl";
            document.getElementById("product-desc").textContent = product.description || "No description available.";
            document.getElementById("product-price").textContent = parseFloat(product.price || 0).toFixed(2);
        })
        .catch(err => {
            console.error(err);
            document.querySelector(".product-page").innerHTML = "<p>Product not found.</p>";
    });
});

document.querySelector('.login-btn').addEventListener('click', ()=> {
    window.location.href = '/login';
});

document.querySelector('.basket-btn').addEventListener('click', () => {
    const banner = document.querySelector('.basket-banner');
    banner.classList.add('active');
    console.log("fjdhjhsjhfffff");
    renderCart();
});

async function amountChanged(input) {
    const product_id = input.id;
    const product = document.getElementById(product_id);
    const currentValue = product.value;
    if (currentValue < 0) {
        product.value = 0;
    };
    const user = await getUser();
    const user_id = user ? user.id : null;
    fetch('/api/amount_changed', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user: user_id, product_id: product_id, amount: currentValue})
    });
}



async function getUser() {
    const response = await fetch('/api/me');
    const data = await response.json();
    console.log("Received data from /api/me: for function getUser", data);
    return data.user;
}

document.querySelector('.close-btn').addEventListener('click', (e) => {
    if (e.target.classList.contains('close-btn')) {
        const banner = document.querySelector('.basket-banner');
        banner.classList.remove('active');
    }
});

document.querySelector('#qty').addEventListener('input', () => {
        qtyInput = parseInt(document.getElementById("qty").value);
        if (qtyInput < 1) {
            document.getElementById("qty").value = 1;
        }
});

async function buyOrder() {
    window.alert("You just bought it!");
    const user = await getUser(); //Get user ID from session or set to null if not logged in
    const user_id = user ? user.id : null;
    console.log("fff", user)
    fetch('/api/buy_basket', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user: user_id})
    });
    const banner = document.querySelector('.basket-banner');
    banner.classList.remove('active');
    document.getElementsByClassName("buy-btn")[0].style.display = "none";
    fetch('/api/create_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: user_id })
                })
};

</script>

</body>
</html>
