<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Pokémarket - Diamond & Pearl</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Optional: make cursor pointer on cards */
        .product-card {
            cursor: pointer;
        }
    </style>
</head>
<body>

<!-- HERO -->
<section class="hero">
    <div class="hero-overlay"></div>

    <header class="top-header">
        <div class="header-inner">
            <div class="logo">
                <a href="/" class="logo-link">
                    <h1>Pokémarket</h1>
                    <p>Samla. Köp. Lev. hej hej</p>
                </a>
            </div>

            <button class="login-btn">Log in</button>
        </div>
        <div class="basket-inner">
            <div></div> <!--ta bort plsss lös på ett bättre sätt-->
            <button class="basket-btn">Basket</button>
            <div class="basket-banner">
                <button class="close-btn">Close</button>
                <h3>Your Basket</h3> 
                <div id="shopping_basket"> </div>
                <button class="buy-btn" style="display:none" onclick="buyOrder()">Buy</button>
            </div>
        </div>
    </header>

    <nav class="category-nav">
        <button class="active">Alla</button>
    </nav>
</section>

<!-- MAIN CONTENT -->
<main class="container">
    <div class="toolbar">
        <div class="sort">
            <label for="sort">Sortera efter:</label>
            <select id="sort">
                <option value="lowPrice">Pris: Lägst först</option>
                <option value="highPrice">Pris: Högst först</option>
                <option value="name">Namn lol</option>
            </select>
        </div>
    </div>

    <section class="products" id="products"></section>
</main>



<script>
document.addEventListener('DOMContentLoaded', () => {
    const productsContainer = document.getElementById('products');
    const loginBtn = document.querySelector('.login-btn');
    fetch('/api/me')
        .then(res => res.json())
        .then(data => {
            console.log('Login state:', data);

            if (data.logged_in) {
                loginBtn.textContent = 'Min profil';
                loginBtn.onclick = () => {
                    window.location.href = `/profile`;
                };
            } else {
                loginBtn.textContent = 'Logga in';
                loginBtn.onclick = () => {
                    window.location.href = `/login`;
                };
            }
        })
        .catch(err => {
            console.error('ME error:', err);
            loginBtn.textContent = 'Logga in';
        });
    // Fetch all products from API
    fetch('/api/products')
        .then(res => res.json())
        .then(data => {
            function renderProducts(products) {
                productsContainer.innerHTML = '';
                products.forEach(product => {
                    const card = document.createElement('div');
                    card.classList.add('product-card');

                    // Make entire card clickable
                    card.addEventListener('click', () => {
                        const params = new URLSearchParams(window.location.search);
                        const id = params.get('id');
                        window.location.href = `/product/${product.product_id}`;
                    });

                    // Replace "200w" with "400w" in imageUrl
                    const highResImageUrl = product.image_url ? product.image_url.replace('200w', '400w') : '';

                    // Card content
                    card.innerHTML = `
                        <img src="${highResImageUrl}" alt="${product.name}">
                        <h3>${product.name}</h3>
                        <p>HP: ${product.ext_hp || '-'}</p>
                        <p>Rarity: ${product.ext_rarity || '-'}</p>
                        <p class="price">${parseFloat(product.price || 0).toFixed(2)} kr</p>
                        <button onclick="event.stopPropagation(); addToCart(${product.product_id}, 1)">Köp</button>
                    `;

                    productsContainer.appendChild(card);
                });
            }

            renderProducts(data);

            // Sorting
            const sortSelect = document.getElementById('sort');
            sortSelect.addEventListener('change', () => {
                const val = sortSelect.value;
                let sorted = [...data];
                if(val === 'lowPrice') sorted.sort((a,b) => parseFloat(a.price)-parseFloat(b.price));
                else if(val === 'highPrice') sorted.sort((a,b) => parseFloat(b.price)-parseFloat(a.price));
                else if(val === 'name') sorted.sort((a,b) => a.name.localeCompare(b.name));
                renderProducts(sorted);
            });

        })
        .catch(err => console.error('Error loading products:', err));
});

document.querySelector('.basket-btn').addEventListener('click', () => {
    const banner = document.querySelector('.basket-banner');
    banner.classList.add('active');
    console.log("fjdhjhsjhfffff");
    renderCart();
});
</script>
<script src="/functions.js"></script>

</body>
</html>
