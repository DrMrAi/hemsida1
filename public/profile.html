<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Pokémarket - Product</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>

<!-- HERO -->
<section class="hero">
    <div class="hero-overlay"></div>

    <header class="top-header">
        <div class="header-inner">
            <div class="logo">
                <a href="/" class="logo-link">
                    <h1>Pokémarket</h1>
                    <p>Samla. Köp. Lev. hej hej</p>
                </a>
            </div>
            <button class="login-btn"></button>
        </div>
    </header>

    <nav class="category-nav">
        <button class="active">Mina Beställningar</button>
    </nav>
</section>

<!-- MAIN CONTENT -->
<main class="container">
    <div id="content">
        <div class="loading">Loading your orders...</div>
    </div>
</main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginBtn = document.querySelector('.login-btn');
            fetch('/api/me')
                .then(res => res.json())
                .then(data => {
                    if (data.logged_in) {
                        loginBtn.textContent = 'Logga ut';
                        loginBtn.onclick = () => {
                            fetch('/api/logout', { method: 'POST' })
                                .then(() => {
                                    window.location.href = `/`;
                                })
                                .catch(err => {
                                    console.error('Logout error:', err);
                                    alert('Error logging out. Please try again.');
                                });
                            window.location.href = `/profile`;
                        };
                    } else {
                        loginBtn.textContent = 'Logga in';
                        loginBtn.onclick = () => {
                            window.location.href = `/login`;
                        };
                    }
                })
                .catch(err => {
                    console.error('ME error:', err);
                    loginBtn.textContent = 'Logga in';
                });
            
            loadOrders();
        });

        async function loadOrders() {
            try {
                // Check if user is logged in
                const meResponse = await fetch('/api/me');
                const meData = await meResponse.json();
                if (!meData.logged_in) {
                    document.getElementById('content').innerHTML = '<div class="error">Please log in to view your orders</div>';
                    return;
                }

                const userID = meData.user.id;
                console.log('Fetching orders for user ID:', userID);

                // Fetch user's orders
                const ordersResponse = await fetch(`/api/orders/${userID}`);
                console.log('Orders response:', ordersResponse);
                if (!ordersResponse.ok) {
                    console.log('Failed to fetch orders:', ordersResponse.status, ordersResponse.statusText);
                    throw new Error('Failed to fetch orders ordersRepson.ok not ok');
                }

                const orders = await ordersResponse.json();
                console.log('Orders data:', orders);
                if (orders.length === 0) {
                    document.getElementById('content').innerHTML = '<div class="no-orders">You have no orders yet</div>';
                    return;
                }

                // Build orders HTML
                let ordersHTML = '<div class="orders-list">';
                
                for (const order of orders) {
                    ordersHTML += `
                        <div class="order-card" onclick="toggleDetails(this, ${order.id}, ${userID})">
                            <div class="order-header">
                                <span class="order-id">Order #${order.id}</span>
                                <span class="order-date">${new Date(order.created_at).toLocaleDateString()}</span>
                            </div>
                            <div class="order-details" id="details-${order.id}"></div>
                        </div>
                    `;
                }

                ordersHTML += '</div>';
                document.getElementById('content').innerHTML = ordersHTML;

            } catch (err) {
                console.error(err);
                document.getElementById('content').innerHTML = `<div class="error">Error loading orders: ${err.message}</div>`;
            }
        }

        async function toggleDetails(element, orderId, userID) {
            const detailsElement = document.getElementById(`details-${orderId}`);
            
            if (detailsElement.classList.contains('show')) {
                detailsElement.classList.remove('show');
                return;
            }

            if (detailsElement.innerHTML === '') {
                try {
                    const response = await fetch(`/api/orders/${userID}/${orderId}`);
                    if (!response.ok) throw new Error('Failed to fetch order details');
                    
                    const orderLines = await response.json();
                    
                    let detailsHTML = '<div style="font-weight: bold; margin-bottom: 10px;">Order Items:</div>';
                    orderLines.forEach(line => {
                        detailsHTML += `
                            <div class="order-line">
                                <span>Product #${line.product_id} - Qty: ${line.amount}</span>
                                <span>$${parseFloat(line.price_at_purchase).toFixed(2)}</span>
                            </div>
                        `;
                    });
                    
                    detailsElement.innerHTML = detailsHTML;
                } catch (err) {
                    detailsElement.innerHTML = `<div class="error">Error loading details: ${err.message}</div>`;
                }
            }

            detailsElement.classList.add('show');
        }

        // Load orders when page loads
        loadOrders();
    </script>
</body>
</html>